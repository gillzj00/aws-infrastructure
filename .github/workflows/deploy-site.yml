name: Deploy Site to CloudFront

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'site/**'

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
        working-directory: ./site
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: site/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN }}
          aws-region: us-west-2

      # Hashed asset files (JS/CSS/images) get long cache â€” Vite fingerprints
      # them so a new build = new filename = automatic cache bust.
      # HTML files get must-revalidate so CloudFront always serves the latest.
      - name: Sync to S3
        run: |
          aws s3 sync dist/ "s3://${{ vars.SITE_BUCKET_NAME }}/" \
            --delete \
            --cache-control "public, max-age=31536000, immutable" \
            --exclude "*.html"

          aws s3 sync dist/ "s3://${{ vars.SITE_BUCKET_NAME }}/" \
            --exclude "*" \
            --include "*.html" \
            --cache-control "public, max-age=0, must-revalidate"

      - name: Invalidate CloudFront cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id "${{ vars.CLOUDFRONT_DISTRIBUTION_ID }}" \
            --paths "/*" \
            --output json > /dev/null
          echo "CloudFront invalidation created"
